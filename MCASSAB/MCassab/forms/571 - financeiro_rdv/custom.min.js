var app=angular.module("RDVApp",["fluig.directives","angular.fluig","ngAnimate","totvs.service","fluig.service"]);app.controller("RDVController",["$scope","$http","$timeout","totvsService","fluigService",function(a,o,e,r,s){a.templatesDir=s.templatesDir+"financeiro_rdv/",s.atualizaFormulario(a,["Geral","DespesaIds","Despesas","Integracao","Ccustos"]).then(function(){a.atualizaEtapa()}),a.resultFieldsUsuario=["colleagueName","mail","colleagueId","colleaguePK.colleagueId"],a.resultFieldsDespesa=["contaContabil","valorPadrao","alteraValor","descricao","alteraQtde","valorLimite","qtdePadrao","ativa"],a.resultFieldsCcusto=["cod_empresa","cod_plano_ccusto","cod_ccusto","displayKey","descricao","responsavel"],a.atualizaEtapa=function(){switch(a.Formulario.today=new Date,a.Params.etapa){case"inicio":if(a.Params.edit){$("form").hide();var o=FLUIGC.loading("body",{textMessage:"Aguarde..."});o.show(),e(function(){a.Usuarios=s.getUsuarios(null,a.resultFieldsUsuario);var e=a.Usuarios.map(function(a){return a.colleagueId.toString()}).indexOf(a.Params.responsavel),t=a.Usuarios[e];a.Despesas=s.getParametroDespesas(null,a.resultFieldsDespesa),a.Ccustos=r.getCcustoUsuario(t.mail),a.Estabelecimentos=r.getEstabelecimento(),"ADD"==a.Params.formMode&&(a.Formulario.Geral={solicitante:t,viajante:t},a.Formulario.Despesas=[],a.Formulario.DespesaIds=[],a.selecionaViajante()),$("form").fadeIn(),o.hide()},1e3)}break;case"revisarSolicitacao":$("form").hide();var o=FLUIGC.loading("body",{textMessage:"Aguarde..."});o.show(),e(function(){var e=s.getUsuarios(a.Params.responsavel,a.resultFieldsUsuario)[0];a.Despesas=s.getParametroDespesas(null,a.resultFieldsDespesa),a.Ccustos=r.getCcustoUsuario(e.mail),a.Estabelecimentos=r.getEstabelecimento(),angular.forEach(a.Formulario.Despesas,function(o,e){var e=a.Despesas.map(function(a){return a.codigo}).indexOf(o.item.codigo);o.item=a.Despesas[e]}),$("form").fadeIn(),o.hide()},1e3);break;case"aprovarDespesasCcusto":a.aprovarTudo(),a.calculaTotalAprovador();break;case"aprovarDespesasGestor":a.aprovarTudo(),a.calculaTotalAprovador();break;case"analisarErrosIntegracao":$("form").hide();var o=FLUIGC.loading("body",{textMessage:"Aguarde..."});o.show(),e(function(){a.Despesas=s.getParametroDespesas(),a.Ccustos=r.getCcusto(),a.Estabelecimentos=r.getEstabelecimento(),$("form").fadeIn(),o.hide()},1e3)}a.Formulario.Integracao&&a.Formulario.Integracao.ttTitulo&&(a.Params.relatorio=!0),FLUIGC.utilities.checkBrowser().isIe()&&$("body").addClass("ie")},a.calculaTotalAprovador=function(){a.Formulario.totalAprovar=0,a.Formulario.totalAprovado=0,a.Formulario.totalReprovado=0,angular.forEach(a.Formulario.Ccustos,function(o,e){a.aprovadorResponsavel(o)&&a.Formulario.Despesas.filter(function(a){return a.ccusto.displayKey==o.displayKey}).forEach(function(o){o.done||(a.Formulario.totalAprovar+=o.valorTotal),"A"==o.status&&(a.Formulario.totalAprovado+=o.valorTotal),"R"==o.status&&(a.Formulario.totalReprovado+=o.valorTotal)})})},a.aprovarTudo=function(){angular.forEach(a.Formulario.Ccustos,function(o,e){a.aprovadorResponsavel(o)&&a.statusGeral(o,"A")})},a.atualizaTotalDespesa=function(o){o&&(o.valorTotal=o.qtde*o.valor),a.Formulario.Geral.valorTotal=0,angular.forEach(a.Formulario.Despesas,function(o){a.Formulario.Geral.valorTotal=a.Formulario.Geral.valorTotal+o.valorTotal})},a.selecionaViajante=function(){if(a.removeDespesas(),"object"==typeof a.Formulario.Geral.viajante&&(a.Formulario.Geral.viajante.colaborador=s.getParametroUsuario(a.Formulario.Geral.viajante.colleagueId)[0],a.Formulario.Geral.viajante.colaborador?a.Formulario.Geral.viajante.colaborador=a.Formulario.Geral.viajante.colaborador.Usuario:(a.Formulario.Geral.viajante.colaborador=r.getFuncionario(a.Formulario.Geral.viajante.mail)[0],a.Formulario.Geral.viajante.colaborador&&(a.Formulario.Geral.viajante.colaborador.ccusto=r.getCcusto(a.Formulario.Geral.viajante.colaborador.cod_empresa_ems,null,a.Formulario.Geral.viajante.colaborador.cod_rh_ccusto)[0],a.Formulario.Geral.viajante.colaborador.estabelecimento=r.getEstabelecimento(a.Formulario.Geral.viajante.colaborador.cod_empresa_ems,a.Formulario.Geral.viajante.colaborador.cod_estab_ems)[0])),a.Formulario.Geral.viajante.colaborador)){if(a.Formulario.Geral.estabelecimento=a.Formulario.Geral.viajante.colaborador.estabelecimento,a.Formulario.Geral.viajante.colaborador.ccusto){var o=a.Ccustos.map(function(a){return a.cod_ccusto}).indexOf(a.Formulario.Geral.viajante.colaborador.ccusto.cod_ccusto);o<0&&a.Ccustos.unshift(a.Formulario.Geral.viajante.colaborador.ccusto)}a.adicionaDespesa()}},a.adicionaDespesa=function(){a.toggleDespesa();var o=wdkAddChild("Despesas");a.Formulario.DespesaIds.unshift(o),a.Formulario.Despesas.unshift({fluigId:o,ccusto:a.Formulario.Geral.viajante.colaborador.ccusto,editing:!0}),$("#despesa___"+o).val(JSON.stringify(a.Formulario.Despesas[0])),e(function(){$("#despesaItem")[0]&&$("#despesaItem")[0].focus()},100)},a.removeDespesa=function(o){fnWdkRemoveChild($("#despesa___"+a.Formulario.Despesas[o].fluigId)[0]),a.Formulario.DespesaIds.splice(o,1),a.Formulario.Despesas.splice(o,1),a.atualizaTotalDespesa()},a.removeDespesas=function(){angular.forEach(a.Formulario.Despesas,function(o,e){a.removeDespesa(e)})},a.saveEditDespesa=function(o){return o.item?o.ccusto?o.valorTotal&&0!=o.valorTotal?o.item.valorLimite>0&&o.valorTotal>o.item.valorLimite?void a.erro("Valor da despesa maior que o limite"):o.obs&&""!=o.obs?void(o.editing?(o.editing=!1,$("#btnAddDespesa").focus()):o.editing=!0):void a.erro("Informe as observações"):void a.erro("Informe o valor"):void a.erro("Informe o centro de custo"):void a.erro("Informe a despesa")},a.toggleDespesa=function(){angular.forEach(a.Formulario.Despesas,function(a){a.editing=!1})},a.aprovadorResponsavel=function(o){return!!a.processDefinition.managerMode||("aprovarDespesasCcusto"==a.Params.etapa?o.aprovador.colleagueId==a.Params.responsavel||o.aprovador.colleagueId==a.processDefinition.taskUserId:"aprovarDespesasGestor"==a.Params.etapa&&(a.Formulario.Geral.gestorCcustoViajante==a.Params.responsavel||a.Formulario.Geral.gestorCcustoViajante==a.processDefinition.taskUserId))},a.statusGeral=function(o,e){angular.forEach(a.Formulario.Despesas,function(a,r){a.ccusto.cod_ccusto!=o.cod_ccusto||a.done||(a.status=e)})},a.erro=function(a){FLUIGC.toast({title:"Erro",message:a,type:"warning",timeout:7e3})},a.imprime=function(){parent.WCMAPI&&parent.WCMAPI.isIe()?printModeView():window.print()}}]);
//# sourceMappingURL=custom.min.js.map
